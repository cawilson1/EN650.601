# Lab1 Certificate Issuance and Revocation

## Content
  - [Introduction](https://github.com/Yu-Tsern/DigitalCertificateLab/tree/master/lab1#introduction)
  - [Network Topology](https://github.com/Yu-Tsern/DigitalCertificateLab/blob/master/lab1/README.md#network-topology)
  - [Certificates Issuance](https://github.com/Yu-Tsern/DigitalCertificateLab/blob/master/lab1/README.md#certificate-issuance)
  - [Server setups](https://github.com/Yu-Tsern/DigitalCertificateLab/blob/master/lab1/README.md#server-setups)
  - [Certificate Issuance Test](https://github.com/Yu-Tsern/DigitalCertificateLab/blob/master/lab1/README.md#certificate-issuance-test)
  - [Certificate Revocation](https://github.com/Yu-Tsern/DigitalCertificateLab/blob/master/lab1/README.md#revoke-a-digital-certificate)
  - [Certificate Revocation Test](https://github.com/Yu-Tsern/DigitalCertificateLab/blob/master/lab1/README.md#certificate-revocation-test)


## Introduction
  Certificate Authorities are trusted third parties that issue electronic documents proving digital entitys' identifications. In public key infrastructure, it is the party that verify ownerships of public keys. In this lab, you will first generate a valid certificate and build a websites upon it. Then, you'll try to connect to this website from another geni node. At last, you will revoke the certificate and test if you can connect to the website with a revoked certificate. 
  
  Software packages used in this labs are listed as follows:
  - OpenSSL: This is a cryptographic toolkit for TLS/SSL, you will use it to generate public private key pairs and digital certificates.
  - LAMP: LAMP is a software bundle named after its software components, Linux operating system, Apache HTTP Server, MySQL database management system and PHP programming language. This bundle is commonly used when building dynamic websites, content of the website is not static, and web applications. It will be used to build your website. 
  - cURL: This is a command-line tool for transferring data. You will use it to test the certificate validity.


## Network topology

![Alt text](pic/Picture101.png?raw=true "Title")


Four VMs are needed in this lab. Node **ca** will be the certificate authority. Node **ws** will be the web server, and it is the node that LAMP will be installed. Node **user** is where you launch your browser and connect to the website. Port numbers of these nodes are summarized in the following table. It is strongly recommended that you write down such table for your own convenience.

Node Name    | Port Number
------------ | -------------
ca           | 27642
ws           | 27644
user         | 27643

**_Notice: Not until all the GENI nodes turn green can you continue the following steps. This may take a while._**

## Certificate Issuance

OpenSSL is a cryptographic toolkit for SSL and TLS. In this lab, it will be used to:

1. generate private key and self-signed certificate for certificate authority,
2. generate private key and certificate signing request for web server,
3. sign the certificate signing request generated by the web server.

Fortunately, this toolkit is pre-installed on GENI, thus no installation is needed. After connecting to the **ca** node, take a look at the "/etc/ssl" directory. This is the directory that stores all files related to Openssl.

```sh
cd /etc/ssl
ls
```
You will see three files under this directory.

```sh
/etc/ssl
    certs
    openssl.cnf
    private
```

“certs” stores the digital certificate of this machine. “private” stores private keys. “openssl.cnf” specifies the configuration of OpenSSL.


### Certificate Authority Configuration

Before this node can function as a certificate authority, some preparations need to be done. First, "index.txt", "newcerts", "crlnumber", and "serial" should be created under this directory.

```sh
/etc/ssl
    certs
    index.txt
    newcerts
    openssl.cnf
    private
    serial
    crlnumber
```

Since all these changes require root privilage, it is suggested to get into root environment before you start. You can exit this environment with "ctrl + D" after these commands are executed.

```sh
sudo su
touch /etc/ssl/index.txt
mkdir /etc/ssl/newcerts
echo 01 > /etc/ssl/serial
echo 00 > /etc/ssl/crlnumber
```
 
Edit "openssl.cnf" either remotely through "vim"/"vi" or transfer the file to your computer and edit it with your own editors. In line 42, replace the directory ".demoCA" with "/etc/ssl."

```sh
 [ CA_default ]
 
 dir             = /etc/ssl              # Where everything is kept
 certs           = $dir/certs            # Where the issued certs are kept
 crl_dir         = $dir/crl              # Where the issued crl are kept
 database        = $dir/index.txt        # database index file.
 #unique_subject = no                    # Set to 'no' to allow creation of
```

In this lab, CA's certificate will be called "ca.crt", and CA's key will be called "ca.key". Modify the name in line 50 and 55.

```
certificate     = $dir/ca.crt           # The CA certificate
serial          = $dir/serial           # The current serial number
crlnumber       = $dir/crlnumber        # the current crl number
                                        # must be commented out to leave a V1 CRL
crl             = $dir/crl.pem          # The current CRL
private_key     = $dir/private/ca.key   # The private key
RANDFILE        = $dir/private/.rand    # private random number file
```
The modification is made for OpenSSL to find your certicicates and private key. Please put them to the specific directory after they are generated. 

[ optional ] Change defaut values in line 129, 134, 139 and 146.

```sh
[ req_distinguished_name ]
countryName                     = Country Name (2 letter code)
countryName_default             = US
countryName_min                 = 2
countryName_max                 = 2

stateOrProvinceName             = State or Province Name (full name)
stateOrProvinceName_default     = MD

localityName                    = Locality Name (eg, city)

0.organizationName              = Organization Name (eg, company)
0.organizationName_default      = JHU

# we can do this but it is not needed normally :-)
#1.organizationName             = Second Organization Name (eg, company)
#1.organizationName_default     = World Wide Web Pty Ltd

organizationalUnitName          = Organizational Unit Name (eg, section)
organizationalUnitName_default  = ISI
```

If you choose to do download the file, here are some tips for file transfer. 

#### SFTP

First, open another terminal and establish a SFTP connection by:

```sh
sftp -i <geni_private_key> -oPort=<geni_port> <user>@<host>
```

For example, 

```sh
sftp -i ~/.ssh/id_geni_ssh_rsa -oPort=27644 yjou2@pc1.geni.it.cornell.edu
```

After putting in the passphrase created when generating your private key, a "sftp>" prompt should appear. Now, use "mget" to fetch the file. If the file is retrieved succefully, it will show you the file name, file size, transfer rate and elapsed time. Your terminal will show you something similar to the followings.

```sh
sftp> mget /etc/ssl/openssl.cnf
Fetching /etc/ssl/openssl.cnf to openssl.cnf
/etc/ssl/openssl.cnf                                            100%   11KB 213.1KB/s   00:00  
```

Once you finish editing the configuration file, use "put" to upload it. If no specific directory is specified, the file will be put into its home directory. 

```sh
sftp> put openssl.cnf
Uploading openssl.cnf to /users/yjou2/openssl.cnf
openssl.cnf                                                     100%   11KB 147.7KB/s   00:00   
```

#### WinSCP

Instructions of how to use WinSCP can be found in this link: http://mountrouidoux.people.cofc.edu/CyberPaths/winscp.html Using WinSCP requires you to change the permission of "openssl.cnf" first.

```sh
sudo chmod 777 openssl.cnf
```

### Generate private key and self-signed certificate

Now, the **ca** node can generate its private key and self-signed certificate. The command of generating private key is:

```sh
sudo openssl genrsa -out /etc/ssl/private/ca.key 2048
```

Note that it is put in "private" as specified in the configuration file. You can check whether the private key was generated succefully by listing files in "private." If everything went well, you will see a "ca.key" in it.

```sh
sudo ls /etc/ssl/private
```

Next, the command of creating self-signed certificate is:

```sh
sudo openssl req -new -x509 -key /etc/ssl/private/ca.key -out /etc/ssl/ca.crt
```

In "openssl.cnf", the location of "ca.crt" is speicified as $dir, which is equivalent to "/etc/ssl" as stated in line 42. When generating certificates, it will ask you to key in information such as country name and organizaton name. If you did modify default values in previous steps, just leave it blank if values inside those brackets are the same as what you expect. Since no server will be setup on **ca** node, you can set whatever common name you like. However, the common name you set for **ws** later should be consistent with your configuration.

```sh
root@ca:/etc/ssl# openssl req -new -x509 -key /etc/ssl/private/cakey.pem -out /etc/ssl/ca.crt
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [US]:
State or Province Name (full name) [MD]:
Locality Name (eg, city) []:Baltimore
Organization Name (eg, company) [JHU]:
Organizational Unit Name (eg, section) [ISI]:
Common Name (e.g. server FQDN or YOUR name) []:jhuca.edu            
Email Address []:
```

### Generate certificate signing request

Now, the **ca** node is ready to sign **ws**'s certificate. The next step is to connect to **ws** node and generate a certificate signing request(CSR). The following commands are used to generate private key and corresponding CSR.

```sh
cd /etc/ssl
sudo su
openssl genrsa -out /etc/ssl/private/jhuws.key 2048
openssl req -new -key /etc/ssl/private/jhuws.key -out /etc/ssl/jhuws.csr
```
 
Similar to the process of generating self-signed certificate on the **ca** node, it will ask you to put in several information. However, the common name cannot be set arbitrarily this time, it should be consistent with your configuration.

```sh
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:US
State or Province Name (full name) [Some-State]:MD
Locality Name (eg, city) []:Baltimore
Organization Name (eg, company) [Internet Widgits Pty Ltd]:JHU
Organizational Unit Name (eg, section) []:ISI
Common Name (e.g. server FQDN or YOUR name) []:jhuws.edu
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
```

### Transfer certificate signing request

Still, there are several ways to transfer your files.

#### SFTP

First, setup a connection with **ws** node and download your CSR.

```sh
sftp -i <geni_private_key> -oPort=<geni_port> <user>@<host>
mget <file_directory>
```

For example, 

```sh
$ sftp -i ~/.ssh/id_geni_ssh_rsa -oPort=27644 yjou2@pc1.geni.it.cornell.edu
Enter passphrase for key '/Users/yu-tsern/.ssh/id_geni_ssh_rsa': 
Connected to pc1.geni.it.cornell.edu.
sftp> mget /etc/ssl/jhuws.csr
Fetching /etc/ssl/jhuws.csr to jhuws.csr
/etc/ssl/jhuws.csr                                              100%  993    18.9KB/s   00:00    
sftp> 
```

Then, setup another connection with the **ca** node. Note that you are not permitted to write to the "etc/ssl" on **ca** directly, thus it is easier to put it in home directory instead. It does not matter where you put the CSR file since the file location can be specified when signing it.

```sh
$ sftp -i ~/.ssh/id_geni_ssh_rsa -oPort=27642 yjou2@pc1.geni.it.cornell.edu
Enter passphrase for key '/Users/yu-tsern/.ssh/id_geni_ssh_rsa': 
Connected to pc1.geni.it.cornell.edu.
sftp> put jhuws.csr
Uploading jhuws.csr to /users/yjou2/jhuws.csr
jhuws.csr                                                       100%  993    36.1KB/s   00:00  
```

#### WinSCP

Still, using WinSCP requires changing permission of "openssl.cnf."

```sh
chmod 777 <file_name>
```

If you're using the same file name as the one used in the previous steps, it is ”chmod 777 jhuws.csr”


### Sign the certificate signing request

After CSR is transfered to the **ca** node, a certificate for **ws** can be generated.

```sh
sudo openssl ca -in <csr_location> -out <certificate_location> -days 3650
```

If you used sftp to transfer CSR, it is probably located at the home directory, thus, the command should look like:

```sh
sudo openssl ca -in ~/jhuws.csr -out ~/jhuws.crt -days 3650
```

It will ask you whether you would like to sign this request. Type "y" to those questions. 

```sh
Using configuration from /usr/lib/ssl/openssl.cnf
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: 1 (0x1)
        Validity
            Not Before: Oct 18 13:30:05 2018 GMT
            Not After : Oct 15 13:30:05 2028 GMT
        Subject:
            countryName               = US
            stateOrProvinceName       = MD
            organizationName          = JHU
            organizationalUnitName    = ISI
            commonName                = jhuws.edu
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                61:E6:2C:B3:52:E6:6B:9F:A0:D6:EC:30:27:27:92:6D:93:1E:D8:6F
            X509v3 Authority Key Identifier: 
                keyid:A7:B4:9F:05:5D:43:03:37:D2:B9:85:C6:EB:35:4C:51:3A:5A:A8:D7

Certificate is to be certified until Oct 15 13:30:05 2028 GMT (3650 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
```

Once **ws**'s certificate is generated, transfer "jhuws.crt", "ca.crt" to **ws** node and "ca.crt" to **user** node. In general, a chain of certificates are needed when the server is proving its ownership of the public key. However, for simplicity, there's only one certificate in the chain in this lab. Additionally, recall that when client sees a chain of certificates, it traces the path of trust back to the root CA and see if it is trust worthy, and that is the reason why "ca.crt" should be transfered to the **user** node. 

If you transfer the certificate through your computer, either by SFTP or WinSCP, you can open it and take a look at its content. Use "cat" command to view it on Linux, or double click it on Mac/Windows. You can see that "jhuws.crt" is issued by "jhuca.edu," which is the certificate authority. 

To enable **ws**’s certificate, the certificate and private key should be put into "/etc/ssl."

```sh
sudo cp <ws_cert_location> /etc/ssl/certs
sudo cp <ws_key_location> /etc/ssl/private
```

For example,

```sh
sudo cp ~/jhuws.crt /etc/ssl/certs
sudo cp /etc/ssl/jhuws.key /etc/ssl/private
```

## Server setups

Since GENI VMs are linux-powered devices, only Apache, MySQL, and PHP need to be install. Note that the order of installation does matter because installation of PHP depends on Apache and MySQL. After you ssh to **ws** node, use  

```sh
sudo apt-get update
```

to update the latest package lists and their dependency.


### Install MySQL:

```sh
sudo apt-get install mysql-server
```

During the installation, it will ask you to setup a password for MySQL administrator. It won't matter at all, just set whatever password you like.

```
Package configuration


    ┌───────────────────────────┤ Configuring mysql-server-5.7 ├────────────────────────────┐
    │ While not mandatory, it is highly recommended that you set a password for the MySQL   │ 
    │ administrative "root" user.                                                           │ 
    │                                                                                       │ 
    │ If this field is left blank, the password will not be changed.                        │ 
    │                                                                                       │ 
    │ New password for the MySQL "root" user:                                               │ 
    │                                                                                       │ 
    │ _____________________________________________________________________________________ │ 
    │                                                                                       │ 
    │                                        <Ok>                                           │ 
    │                                                                                       │ 
    └───────────────────────────────────────────────────────────────────────────────────────┘ 


```

When the installation is completed, check whether it is installed successfully through the following command.

```sh
sudo netstat -tap | grep mysql
```

You will see a message similar to the following one, which means there is a listening port of mysql.

```sh
tcp        0      0 localhost:mysql         *:*                     LISTEN      18658/mysqld  
```

 
### Install Apache

```sh
sudo apt-get install apache2
```

You will run a browser to check whether it is installed successfully after all other settings are completed.

### Install PHP

```sh
sudo apt-get install php-pear php-fpm php-dev php-zip php-curl php-xmlrpc php-gd php-mysql php-mbstring php-xml libapache2-mod-php
```

It may take a while to install these packages. After it is installed, a “www” folder will be created under "var." This folder will store source codes of the website.

```sh
/var
    backups
    cache
    emulab
    lib
    local
    lock
    log  
    mail  
    opt  
    run  
    spool  
    tmp  
    www
```

In addition to PHP itself, some other extensions are needed as well.

```sh
sudo apt-get install php-intl php-imagick php-imap php-mcrypt php-memcache php7.0-ps php-pspell php-recode php-snmp php7.0-sqlite php-tidy php7.0-xsl
```

**_Notice: the GENI node is initiated with an Ubuntu operation system by default. If you choose other operation systems rather the default one, there might be a warning message showing that it may fail to initiate the GENI nodes._**

### Write a simple PHP website

You will write a simple PHP website and try to connect to it in order to test whether PHP was installed successfully. You can use whatever way you like to write the PHP source code. Recall that "www" stores the website source code. To make change to this file, first change its permission.

```sh
sudo chmod 777 /var/www
```

Second, create a file named “info.php” under the “/var/www/html” folder, then copy these codes into this file:

```php
<?php
phpinfo();
?>
```

Third, restart the Apache service.

```sh
sudo /etc/init.d/apache2 restart
```

To connect to it, some other configurations are needed. This part will be covered in the next section. 

### Enable Apache SSL connection

In this lab, the connection test will be done by SSL connection, thus, it is required to enable SSL connection on Apache server. In the "/etc/apache2" directory, you can see “apache2.conf”, which specifies the apache configuration. Those "include" are used to add other configuration file. 

```sh
# Include module configuration:
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf

# Include list of ports to listen on
Include ports.conf
```

To enable SSL connection, copy "default-ssl.conf" from "sites-available" to "sites-enabled" directory.

```sh
sudo cp /etc/apache2/sites-available/default-ssl.conf  /etc/apache2/sites-enabled/default-ssl.conf
```

Then, use 

```sh
ifconfig
```

to find IP address, and modify "/etc/apache2/sites-enabled/default-ssl.conf": In line 2, replace "_default_" with the IP address you just found. Do not remove “:443” after the IP addres. It is the port number for SSL connection. In line 4, insert a line and specify your ServerName. In line 32, 33, and 34, change the directory to where your certificate and private key are stored, and add a new line specifying SSLCertificateChainFile.


```sh
<IfModule mod_ssl.c>
        <VirtualHost 172.17.1.14:443>
                ServerAdmin webmaster@localhost
                ServerName www.jhuws.edu
                DocumentRoot /var/www/html

                # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
                # error, crit, alert, emerg.
                # It is also possible to configure the loglevel for particular
                # modules, e.g.
                #LogLevel info ssl:warn

                ErrorLog ${APACHE_LOG_DIR}/error.log
                CustomLog ${APACHE_LOG_DIR}/access.log combined

                # For most configuration files from conf-available/, which are
                # enabled or disabled at a global level, it is possible to
                # include a line for only one particular virtual host. For example the
                # following line enables the CGI configuration for this host only
                # after it has been globally disabled with "a2disconf".
                #Include conf-available/serve-cgi-bin.conf

                #   SSL Engine Switch:
                #   Enable/Disable SSL for this virtual host.
                SSLEngine on

                #   A self-signed (snakeoil) certificate can be created by installing
                #   the ssl-cert package. See
                #   /usr/share/doc/apache2/README.Debian.gz for more info.
                #   If both key and certificate are stored in the same file, only the
                #   SSLCertificateFile directive is needed.
                SSLCertificateFile      /etc/ssl/certs/jhuws.crt
                SSLCertificateChainFile /etc/ssl/certs/ca.crt
                SSLCertificateKeyFile /etc/ssl/private/jhuws.key
```

After it is modified, check whether the configuration is correct:

```
apachectl configtest
```

Use

```sh
sudo a2enmod ssl
```

to enable the SSL module of Apache2. Then, restart apache2 server using command:

```sh
sudo service apache2 restart
```

## Certificate Issuance Test

Now you can test the result of all the previous work by connecting web server from the **user** node. First, ssh the **user** node. Then, modify the hosts file. It is the file that translates names of websites to IP addresses before the machine made a DNS request. To modify it, change the permission of this file

```sh
sudo chmod 777 /etc/hosts
```

and edit it so that the server name "jhuws.edu" is mapped to the IP addresses.

```sh
127.0.0.1       localhost loghost localhost.pkileo.ch-geni-net.geni.it.cornell.edu
10.10.2.1       ATK-link-1 ATK-0 ATK
10.10.1.1       CA-link-0 CA-0 CA
10.10.3.1       USER-link-2 USER-0 USER
10.10.3.2       WS-link-2 WS-2 WS
10.10.1.2       WS-link-0 WS-1
10.10.2.2       WS-link-1 WS-0
172.17.2.14     jhuws.edu
172.17.2.14     www.jhuws.edu
```

“172.17.2.14” is the IP address of **ws** node. And "jhuws.edu" should be the server name you set up before. After these changes are made, put "ca.crt" into /etc/ssl/certs on the **user** node, and create a symbolic link for it (more details of symbolic link can be found [here](http://gagravarr.org/writing/openssl-certs/others.shtml#ca-openssl)).
```
ln -s ca.crt `openssl x509 -hash -noout -in ca.crt`.0
```
Finally, use openssl to test the connection.

```
openssl s_client -showcerts -connect www.jhuws.edu:443
```
If everything went well, you will see message like
```
CONNECTED(00000003)
depth=1 C = US, ST = MD, L = Baltimore, O = JHU, OU = ISI, CN = jhuca.edu
verify return:1
depth=0 C = US, ST = MD, O = JHU, OU = ISI, CN = jhuws.edu
verify return:1
```

## Revoke a digital certificate

Now, try to revoke the digital certificate. First, connect to the **ca** node and use this command to revoke the digital certificate.

```sh
sudo openssl ca -revoke jhuws.crt
```

You will see two messages, "Revoking Certificate XX(some number)" and "Data Base Updated." For example, 

```sh
Using configuration from /usr/lib/ssl/openssl.cnf
Revoking Certificate 01.
Data Base Updated
```

To make sure it is the one you expected, use 

```sh
cat index.txt
```

to see details of the certificate corresponding to that number. Now, create a new Certificate Revocation List(CRL) with this command:

```sh
sudo openssl ca -gencrl -out ca.crl
```

Recall that CRL is the file that stores all the revoked certificate. You can take a look at the CRL by using

```sh
cat ca.crl
```

Initially, the ”crlnumber” was set to "00". Everytime a certificate is revoked, this number will increase by one. Finally, the digital certificate is successfully revoked.


## Certificate Revocation Test

Move the Certificate Revokation List, "ca.crl," to the **user** node. Since OpenSSL does not support CRL funtion although command like "-CRL" or "-CRLform" do exist, test the connection with curl. Note that CRL is included this time.
```
curl https://jhuws.edu --cacert ca.crt --crlfile ca.crl
```
You will see there's an error complaining the certificate was revoked.

## Assignments

1. Google announces to mark the sites without HTTPS in chrome as non-secure by the end of January 2017, which means HTTPS is now mandatory for secure data in chrome. What’s the reason for Google to do so?

2. Find out one of the digital certificate stored on your laptop. Screenshot the digital certificate you found on your laptop.

3. X.509 is a popular SSL digital certificate standard, what content is included in the digital certificate in X.509 standard? Check the content in our digital certificate, screen shot it.

4. Use OpenSSL's "s_client" to test the certication of a public known website. For example, Google, Amazon, Linkedin, etc. Include the result in your report and describe your observation. 
